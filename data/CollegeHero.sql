-- Tables

DROP DATABASE IF EXISTS CollegeHero;
CREATE DATABASE CollegeHero;
USE CollegeHero;

DROP TABLE IF EXISTS student;
CREATE TABLE student
(sID INT PRIMARY KEY AUTO_INCREMENT,
 name VARCHAR(255) NOT NULL,
 password VARCHAR(60) NOT NULL,
 sex BOOLEAN,
 phone VARCHAR(10)
);

DROP TABLE IF EXISTS room;
CREATE TABLE room
(rID INT PRIMARY KEY AUTO_INCREMENT,
 roomNumber INT,
 building VARCHAR(45)
);

DROP TABLE IF EXISTS department;
CREATE TABLE department
(dID INT PRIMARY KEY AUTO_INCREMENT,
office INT,
title VARCHAR(45) NOT NULL,
FOREIGN KEY (office) REFERENCES room (rID)
);

DROP TABLE IF EXISTS staff;
CREATE TABLE staff
(tID INT PRIMARY KEY AUTO_INCREMENT,
 name VARCHAR(255) NOT NULL,
 password VARCHAR(60) NOT NULL,
 department INT,
 staffTypeID INT,
 phone VARCHAR(10),
 FOREIGN KEY (department) REFERENCES department (dID)
);

DROP TABLE IF EXISTS class;
CREATE TABLE class
(cID INT PRIMARY KEY AUTO_INCREMENT,
 section INT NOT NULL,
 subject VARCHAR(45) NOT NULL,
 tID INT,
 rID INT,
 days VARCHAR(15),
 start_at TIME,
 end_at TIME,
 FOREIGN KEY (tID) REFERENCES staff (tID),
 FOREIGN KEY (rID) REFERENCES room (rID)
);

DROP TABLE IF EXISTS enrolled;
CREATE TABLE enrolled
(sID INT,
 cID INT,
 fee INT NOT NULL,
 PRIMARY KEY (sID, cID),
 FOREIGN KEY (sID) REFERENCES student (sID),
 FOREIGN KEY (cID) REFERENCES class (cID)
);

DROP TABLE IF EXISTS attendance;
CREATE TABLE attendance
(sID INT,
 cID INT,
 day DATE,
 PRIMARY KEY (sID, cID, day),
 FOREIGN KEY (sID) REFERENCES student (sID),
 FOREIGN KEY (cID) REFERENCES class (cID)
);

-- Procedures

DELIMITER //

DROP PROCEDURE IF EXISTS getStudentByID//
CREATE PROCEDURE getStudentByID (IN ID INT)
BEGIN
  SELECT * FROM student
  WHERE sID = ID;
END//

DROP PROCEDURE IF EXISTS getStaffByID//
CREATE PROCEDURE getStaffByID (IN ID INT)
 BEGIN
  SELECT * FROM staff
  WHERE tID = ID;
 END//

DROP PROCEDURE IF EXISTS getStudentIDByPhone//
CREATE PROCEDURE getStudentIDByPhone (IN phone VARCHAR(10))
 BEGIN
  SELECT sID, student.name, student.phone FROM student
  WHERE student.phone = phone;
 END//

DROP PROCEDURE IF EXISTS getStaffIDByPhone//
CREATE PROCEDURE getStaffIDByPhone (IN phone VARCHAR(10))
 BEGIN
  SELECT tID, staff.name, staff.phone FROM staff
  WHERE staff.phone = phone;
 END//

DROP PROCEDURE IF EXISTS createStudent//
CREATE PROCEDURE createStudent (IN name VARCHAR(255), IN password VARCHAR(60), IN sex BOOLEAN, IN phone VARCHAR(10))
BEGIN
 INSERT INTO student VALUES (NULL, name, password, sex, phone);
END//

DROP PROCEDURE IF EXISTS createStaff//
CREATE PROCEDURE createStaff
(IN name VARCHAR(255), IN password VARCHAR(60), IN department INT, IN staffType INT, IN phone VARCHAR(10))
 BEGIN
  INSERT INTO staff VALUES (NULL, name, password, department, staffType, phone);
 END//

DELIMITER ;

-- Data sources

LOAD DATA LOCAL INFILE 'students.csv'
INTO TABLE student
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
IGNORE 1 LINES;

LOAD DATA LOCAL INFILE 'room.csv'
INTO TABLE room
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
IGNORE 1 LINES;

LOAD DATA LOCAL INFILE 'department.csv'
INTO TABLE department
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
IGNORE 1 LINES;

LOAD DATA LOCAL INFILE 'staff.csv'
INTO TABLE staff
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
IGNORE 1 LINES;

LOAD DATA LOCAL INFILE 'class.csv'
INTO TABLE class
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
IGNORE 1 LINES;
